#!/usr/bin/env bash

# clean up previous session
which killall >/dev/null 2>&1 \
    && killall aseba{switch,dummynode} \
    || ps | egrep 'aseba(switch|dummynode)' | while read pid rest; do
		kill $pid;
done

# first dummy node
@ASEBADUMMYNODE@ 0 &
dummy0pid=$!
sleep 2

# run switch
@ASEBASWITCH@ --dump --port 33335 "tcp:localhost;33333" "tcp:localhost;33334" 1>&2 &
switchpid=$!
sleep 3

# run a second dummy node, switch should connect
@ASEBADUMMYNODE@ 1 &
dummy1pid=$!
sleep 2

# kill first dummy node
kill $dummy0pid
sleep 2

# restart first dummy
@ASEBADUMMYNODE@ 0 &
dummy0pid=$!
sleep 3

# at this point, both dummynodes should be running, and the switch should be
# connected to them

# run e2e tests
status=0
for filename in *.js; do
	echo "Running test set $filename"
	node_modules/jasmine-node/bin/jasmine-node $filename
	status=$(($status+$?))
done
echo "Failed $status test set(s)"

# stop second dummynode
kill $dummy1pid
sleep 1

# stop switch
kill $switchpid
sleep 1

# stop first dummynode
kill $dummy0pid
sleep 1

exit $status
